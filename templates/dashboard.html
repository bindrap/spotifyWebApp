<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-user-music me-2"></i>Welcome, {{ user_name }}!</h2>
                <p class="text-muted">Choose what you'd like to export</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Liked Songs Card -->
    <div class="col-md-6 mb-4">
        <div class="card card-hover shadow-sm h-100">
            <div class="card-body text-center">
                <i class="fas fa-heart text-danger fa-3x mb-3"></i>
                <h5 class="card-title">Liked Songs</h5>
                <p class="text-muted">{{ liked_count }} songs</p>
                <button class="btn spotify-green text-white" onclick="downloadLiked()">
                    <i class="fas fa-download me-2"></i>Export Liked Songs
                </button>
            </div>
        </div>
    </div>

    <!-- All Playlists Card -->
    <div class="col-md-6 mb-4">
        <div class="card card-hover shadow-sm h-100">
            <div class="card-body text-center">
                <i class="fas fa-list text-primary fa-3x mb-3"></i>
                <h5 class="card-title">All Playlists</h5>
                <p class="text-muted">{{ playlists|length }} playlists</p>
                <button class="btn btn-primary" onclick="downloadAll()">
                    <i class="fas fa-download me-2"></i>Export All Playlists
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Individual Playlists -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-music me-2"></i>Your Playlists</h4>
        {% if playlists %}
        <div class="row">
            {% for playlist in playlists %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card card-hover shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">{{ playlist.name }}</h6>
                        <p class="card-text text-muted">
                            <i class="fas fa-music me-1"></i>{{ playlist.tracks }} tracks
                        </p>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadPlaylist('{{ playlist.id }}', '{{ playlist.name }}')">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No playlists found. Create some playlists in Spotify first!
        </div>
        {% endif %}
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exporting...</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar spotify-green" role="progressbar" style="width: 0%">0%</div>
                </div>
                <p id="progressStatus">Starting export...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeBtn" style="display: none;">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let progressModal;
let progressInterval;

document.addEventListener('DOMContentLoaded', function() {
    progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
});

function downloadLiked() {
    startDownload('/download_liked', 'Liked Songs');
}

function downloadPlaylist(playlistId, playlistName) {
    startDownload(`/download_playlist/${playlistId}`, playlistName);
}

function downloadAll() {
    alert('This feature is coming soon!');
}

function startDownload(url, name) {
    // Reset progress modal
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').textContent = '0%';
    document.getElementById('progressStatus').textContent = `Starting export of ${name}...`;
    document.getElementById('closeBtn').style.display = 'none';
    
    progressModal.show();
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.session_id) {
                trackProgress(data.session_id);
            } else {
                showError(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            showError('Failed to start download: ' + error.message);
        });
}

function trackProgress(sessionId) {
    progressInterval = setInterval(() => {
        fetch(`/progress/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                const progress = data.progress || 0;
                const status = data.status || 'Processing...';
                
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressBar').textContent = progress + '%';
                document.getElementById('progressStatus').textContent = status;
                
                if (data.completed) {
                    clearInterval(progressInterval);
                    document.getElementById('closeBtn').style.display = 'block';
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                showError('Error tracking progress: ' + error.message);
            });
    }, 1000);
}

function showError(message) {
    clearInterval(progressInterval);
    document.getElementById('progressStatus').textContent = 'Error: ' + message;
    document.getElementById('progressBar').className = 'progress-bar bg-danger';
    document.getElementById('closeBtn').style.display = 'block';
}
</script>
{% endblock %}